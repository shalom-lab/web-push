name: Daily Push Notification

on:
  schedule:
    - cron: '0 1 * * *' # æ¯å¤© UTC+0 9AM æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      title:
        description: 'é€šçŸ¥æ ‡é¢˜'
        required: false
        default: 'ğŸ‰ æ„å»ºå®Œæˆ'
      body:
        description: 'é€šçŸ¥å†…å®¹'
        required: false
        default: 'GitHub Actions å·²è¿è¡Œï¼'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥æ—¶é—´
        run: |
          echo "å½“å‰æ—¶é—´: $(date)"
          echo "æ—¶åŒº: $(date +%Z)"
          echo "UTCæ—¶é—´: $(date -u)"
      
      - name: å‘é€æ¨é€é€šçŸ¥
        env:
          SERVER_URL: ${{ secrets.PUSH_SERVER_URL }}
          API_KEY: ${{ secrets.PUSH_API_KEY }}
        run: |
          # è·å–é€šçŸ¥å†…å®¹
          TITLE="${{ github.event.inputs.title || 'ğŸ‰ æ„å»ºå®Œæˆ' }}"
          BODY="${{ github.event.inputs.body || 'GitHub Actions å·²è¿è¡Œï¼' }}"
          
          # æ„å»ºé€šçŸ¥æ•°æ®
          NOTIFICATION_DATA=$(cat <<EOF
          {
            "title": "$TITLE",
            "body": "$BODY",
            "data": {
              "repository": "${{ github.repository }}",
              "workflow": "${{ github.workflow }}",
              "run_id": "${{ github.run_id }}",
              "timestamp": "$(date -u -Iseconds)"
            }
          }
          EOF
          )
          
          echo "å‘é€é€šçŸ¥: $NOTIFICATION_DATA"
          
          # å‘é€é€šçŸ¥
          if [ -n "$SERVER_URL" ]; then
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST "$SERVER_URL/notify" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d "$NOTIFICATION_DATA")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
            
            echo "å“åº”çŠ¶æ€ç : $HTTP_CODE"
            echo "å“åº”å†…å®¹: $RESPONSE_BODY"
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "âœ… é€šçŸ¥å‘é€æˆåŠŸ"
            else
              echo "âŒ é€šçŸ¥å‘é€å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
              exit 1
            fi
          else
            echo "âš ï¸ æœªé…ç½®æ¨é€æœåŠ¡å™¨åœ°å€ï¼Œè·³è¿‡é€šçŸ¥å‘é€"
          fi
      
      - name: è®°å½•æ‰§è¡Œæ—¥å¿—
        run: |
          echo "## é€šçŸ¥å‘é€æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "- æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- ä»“åº“: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- å·¥ä½œæµ: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- è¿è¡ŒID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- è§¦å‘æ–¹å¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY 